// Global variables
let currentDiscussions = [];
let currentDiscussion = null;
let searchTimeout = null;

console.log('ğŸš€ í† ë¡  ê²Œì‹œíŒ v2.0 ë¡œë“œë¨ - ', new Date().toLocaleString());
let currentFilters = {
    search: '',
    sort: 'recent',
    type: ''
};

// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ í† ë¡ ë°© ë°ì´í„°
let localDiscussions = JSON.parse(localStorage.getItem('localDiscussions') || '[]');

// Sample data for fallback - ë¹„ì–´ìˆìŒ (ì´ˆê¸° í™”ë©´ì— ì•„ë¬´ê²ƒë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
const sampleDiscussions = [];

// DOM Elements
const loadingOverlay = document.getElementById('loadingOverlay');
const discussionsGrid = document.getElementById('discussionsGrid');
const emptyState = document.getElementById('emptyState');
const searchInput = document.getElementById('searchInput');
const sortSelect = document.getElementById('sortSelect');
const typeFilter = document.getElementById('typeFilter');
const newDiscussionModal = document.getElementById('newDiscussionModal');
const discussionDetailModal = document.getElementById('discussionDetailModal');
const toast = document.getElementById('toast');

// Statistics elements (removed - no longer used)

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    setupEventListeners();
});

async function initializeApp() {
    showLoading();
    try {
        await loadDiscussions();
    } catch (error) {
        console.error('ì•± ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        showToast('ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
        hideLoading();
    }
}

function setupEventListeners() {
    // Search input
    searchInput.addEventListener('input', handleSearch);

    // Sort and filter
    sortSelect.addEventListener('change', handleSortChange);
    typeFilter.addEventListener('change', handleTypeFilter);

    // New discussion form
    const newDiscussionForm = document.getElementById('newDiscussionForm');
    newDiscussionForm.addEventListener('submit', handleNewDiscussion);

    // Opinion form - event listener registered in DOMContentLoaded (line 1273)

    // Modal close on outside click
    newDiscussionModal.addEventListener('click', (e) => {
        if (e.target === newDiscussionModal) {
            closeNewDiscussionModal();
        }
    });

    discussionDetailModal.addEventListener('click', (e) => {
        if (e.target === discussionDetailModal) {
            closeDiscussionDetailModal();
        }
    });

    // Auto-refresh discussions every 30 seconds
    setInterval(loadDiscussions, 30000);

    // ëª¨ë“œ ë³€ê²½ ì´ë²¤íŠ¸
    const modeRadios = document.querySelectorAll('input[name="discussionMode"]');
    modeRadios.forEach(radio => {
        radio.addEventListener('change', handleModeChange);
    });

    // ê¸°ê°„ ì„ íƒ ì´ë²¤íŠ¸
    const durationSelect = document.getElementById('discussionDuration');
    if (durationSelect) {
        durationSelect.addEventListener('change', handleDurationChange);
    }

    // ë¹„ë°€ê¸€ í† ê¸€ ì´ë²¤íŠ¸
    const privateToggle = document.getElementById('isPrivateDiscussion');
    if (privateToggle) {
        privateToggle.addEventListener('change', handlePrivateToggle);
    }

    // ì…ì¥ì½”ë“œ ì…ë ¥ë€ì—ì„œ Enter í‚¤ ì´ë²¤íŠ¸
    const entryCodeInput = document.getElementById('entryCodeInput');
    if (entryCodeInput) {
        entryCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyEntryCode();
            }
        });
    }

    // í† ë¡  ì œëª© ì…ë ¥ ì‹œ ìë™ AI ì„¤ëª… ìƒì„±
    const discussionTitle = document.getElementById('discussionTitle');
    let titleTimeout = null;
    discussionTitle.addEventListener('input', (e) => {
        clearTimeout(titleTimeout);
        titleTimeout = setTimeout(() => {
            const title = e.target.value.trim();
            if (title && title.length > 3) {
                autoGenerateDescription(title);
            }
        }, 1500); // 1.5ì´ˆ í›„ ìë™ ìƒì„±
    });
}

// Loading functions
function showLoading() {
    loadingOverlay.classList.remove('hidden');
}

function hideLoading() {
    loadingOverlay.classList.add('hidden');
}

// API functions
async function apiRequest(url, options = {}) {
    try {
        const response = await fetch(url, {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        return await response.json();
    } catch (error) {
        console.error('API ìš”ì²­ ì˜¤ë¥˜:', error);
        throw error;
    }
}

async function loadDiscussions() {
    console.log('í† ë¡  ëª©ë¡ ë¡œë“œ ì‹œì‘...');

    try {
        // APIë¡œë¶€í„° ë°ì´í„° ë¡œë“œ
        const response = await fetch(`/api/discussions?search=${encodeURIComponent(currentFilters.search)}&sort=${currentFilters.sort}&type=${encodeURIComponent(currentFilters.type)}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const discussions = await response.json();
        currentDiscussions = discussions;
        // API ë°ì´í„°ë¥¼ localDiscussionsì™€ ë™ê¸°í™”
        localDiscussions = discussions;
        localStorage.setItem('localDiscussions', JSON.stringify(localDiscussions));

        console.log('APIë¡œë¶€í„° í† ë¡  ëª©ë¡ ë¡œë“œ ì™„ë£Œ, ì´', discussions.length, 'ê°œì˜ í† ë¡ ë°©');
        renderDiscussions();

    } catch (error) {
        console.error('API í˜¸ì¶œ ì‹¤íŒ¨, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë°±:', error);

        // API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë°±
        localDiscussions = JSON.parse(localStorage.getItem('localDiscussions') || '[]');
        let discussions = [...localDiscussions];

        // ê²€ìƒ‰ í•„í„° ì ìš©
        if (currentFilters.search) {
            const searchLower = currentFilters.search.toLowerCase();
            discussions = discussions.filter(d =>
                d.title.toLowerCase().includes(searchLower) ||
                d.author.toLowerCase().includes(searchLower) ||
                d.type.toLowerCase().includes(searchLower)
            );
        }

        // ì •ë ¬ ì ìš©
        if (currentFilters.sort === 'participants') {
            discussions.sort((a, b) => b.participants - a.participants);
        } else {
            discussions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        }

        // íƒ€ì… í•„í„° ì ìš©
        if (currentFilters.type) {
            currentDiscussions = discussions.filter(d => d.type === currentFilters.type);
        } else {
            currentDiscussions = discussions;
        }

        console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë°±ìœ¼ë¡œ í† ë¡  ëª©ë¡ ë¡œë“œ ì™„ë£Œ, ì´', currentDiscussions.length, 'ê°œì˜ í† ë¡ ë°©');
        renderDiscussions();
    }
}

function renderDiscussions() {
    console.log('í† ë¡ ë°© ë Œë”ë§ ì‹œì‘, í† ë¡  ìˆ˜:', currentDiscussions.length);

    if (currentDiscussions.length === 0) {
        console.log('í† ë¡ ë°©ì´ ì—†ì–´ì„œ ë¹ˆ ìƒíƒœ í‘œì‹œ');
        discussionsGrid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    console.log('í† ë¡ ë°© ì¹´ë“œ ë Œë”ë§ ì¤‘...');
    discussionsGrid.style.display = 'grid';
    emptyState.style.display = 'none';

    discussionsGrid.innerHTML = currentDiscussions.map(discussion => `
        <div class="discussion-card" onclick="window.location.href='room.html?id=${discussion.id}'">
            <div class="card-header">
                <h3 class="discussion-title">
                    ${discussion.is_private === true ? '<i class="fas fa-lock"></i> ' : ''}${escapeHtml(discussion.title)}
                </h3>
                <div class="type-badge ${discussion.type}">${discussion.type}</div>
                <div class="card-actions">
                    ${renderActionButtons(discussion)}
                </div>
            </div>

            <div class="card-meta">
                <div class="meta-item author-info">
                    <i class="fas fa-user"></i>
                    <span>ê°œì„¤ì: ${escapeHtml(discussion.author)}</span>
                </div>
                <div class="meta-item participants-info">
                    <i class="fas fa-users"></i>
                    <span>ì‹¤ì‹œê°„ ì°¸ì—¬ ì¸ì›: ${discussion.participants}ëª…</span>
                </div>
            </div>

            <div class="time-remaining">
                <i class="fas fa-clock"></i>
                <span>ì‚­ì œê¹Œì§€: ${discussion.timeRemaining} ë‚¨ìŒ</span>
            </div>
        </div>
    `).join('');

    console.log('í† ë¡ ë°© ì¹´ë“œ ë Œë”ë§ ì™„ë£Œ');
}

// Statistics function removed - no longer needed

// Search and filter functions
function handleSearch(e) {
    const value = e.target.value.trim();

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        currentFilters.search = value;
        loadDiscussions();
    }, 300);
}

function handleSortChange(e) {
    currentFilters.sort = e.target.value;
    loadDiscussions();
}

function handleTypeFilter(e) {
    currentFilters.type = e.target.value;
    loadDiscussions();
}

// Modal functions
function openNewDiscussionModal() {
    newDiscussionModal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeNewDiscussionModal() {
    newDiscussionModal.classList.remove('active');
    document.body.style.overflow = '';

    // Reset form
    const newDiscussionForm = document.getElementById('newDiscussionForm');
    newDiscussionForm.reset();

    // ìˆ˜ì • ëª¨ë“œ í•´ì œ
    delete newDiscussionForm.dataset.editMode;
    delete newDiscussionForm.dataset.editId;

    // ëª¨ë‹¬ íƒ€ì´í‹€ ì›ë³µ
    document.querySelector('#newDiscussionModal h2').textContent = 'ìƒˆ í† ë¡  ì‹œì‘í•˜ê¸°';

    // ì œì¶œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ë³µ
    document.querySelector('#newDiscussionForm button[type="submit"]').textContent = 'ìƒì„±';

    // ìˆ¨ê²¨ì§„ ì„¹ì…˜ë“¤ ì´ˆê¸°í™”
    document.getElementById('prosConsSection').style.display = 'none';
    document.getElementById('roleSection').style.display = 'none';
    document.getElementById('customDurationSection').style.display = 'none';
}

async function openDiscussionDetail(id, skipPrivateCheck = false) {
    try {
        showLoading();
        console.log('í† ë¡  ìƒì„¸ ì •ë³´ ë¡œë“œ:', id);

        // ì„œë²„ì—ì„œ ìµœì‹  í† ë¡  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        let discussion;
        try {
            const response = await fetch(`/api/discussions/${id}`);
            if (response.ok) {
                discussion = await response.json();
                console.log('ì„œë²„ì—ì„œ í† ë¡  ì •ë³´ ë¡œë“œ:', discussion);
            } else {
                throw new Error('ì„œë²„ì—ì„œ í† ë¡ ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì„œë²„ API í˜¸ì¶œ ì‹¤íŒ¨, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë°±:', error);
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í† ë¡  ì°¾ê¸° (í´ë°±)
            discussion = localDiscussions.find(d => d.id == id);
        }

        if (!discussion) {
            console.error('í† ë¡ ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', id);
            showToast('í† ë¡  ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            hideLoading();
            return;
        }

        // ë¹„ë°€ê¸€ì¸ ê²½ìš° ì…ì¥ì½”ë“œ ê²€ì¦ (skipPrivateCheckê°€ trueê°€ ì•„ë‹ ë•Œë§Œ)
        if (discussion.is_private && !skipPrivateCheck) {
            console.log('ë¹„ë°€ê¸€ í† ë¡ ë°© ê°ì§€:', discussion.title);
            hideLoading();
            await showEntryCodeModal(id);
            return;
        }

        console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í† ë¡  ìƒì„¸ ì •ë³´ ë¡œë“œ:', discussion);
        currentDiscussion = discussion;

        // Update modal content
        document.getElementById('detailTitle').textContent = discussion.title;
        document.getElementById('detailAuthor').textContent = `ğŸ‘¤ ${discussion.author}`;
        document.getElementById('detailParticipants').textContent = `ğŸ‘¥ ${discussion.participants}ëª…`;
        document.getElementById('detailTimeRemaining').textContent = `â° ${discussion.timeRemaining}`;
        document.getElementById('detailType').textContent = discussion.type;
        document.getElementById('detailType').className = `type-badge ${discussion.type}`;
        document.getElementById('detailDescription').textContent = discussion.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';

        // ì„œë²„ì—ì„œ ì˜ê²¬ ë¡œë“œ
        await loadOpinions(discussion.id);

        discussionDetailModal.classList.add('active');
        document.body.style.overflow = 'hidden';

    } catch (error) {
        console.error('í† ë¡  ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        showToast('í† ë¡  ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    } finally {
        hideLoading();
    }
}

function closeDiscussionDetailModal() {
    discussionDetailModal.classList.remove('active');
    document.body.style.overflow = '';
    currentDiscussion = null;

    // Reset opinion form
    document.getElementById('opinionForm').reset();

    // Reload discussions to update participant counts
    loadDiscussions();
}

function renderOpinions(opinions, type) {
    const container = document.getElementById(`${type}Opinions`);

    if (opinions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ì•„ì§ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    container.innerHTML = opinions.map(opinion => `
        <div class="opinion-card">
            <div class="opinion-author">${escapeHtml(opinion.author)}</div>
            <div class="opinion-text">${escapeHtml(opinion.content)}</div>
            <div class="opinion-footer">
                <span>${formatTimeAgo(opinion.created_at)}</span>
                <button class="like-btn" onclick="likeOpinion(${opinion.id})">
                    <i class="fas fa-thumbs-up"></i>
                    ${opinion.likes_count}
                </button>
            </div>
        </div>
    `).join('');
}

// Form handlers
async function handleNewDiscussion(e) {
    e.preventDefault();

    // ê¸°ê°„ ê³„ì‚°
    let duration;
    const durationSelect = document.getElementById('discussionDuration');
    if (durationSelect.value === 'custom') {
        const customDuration = document.getElementById('customDuration').value;
        duration = parseInt(customDuration) * 24; // ì¼ì„ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
    } else {
        duration = parseInt(durationSelect.value) * 24; // ì¼ì„ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
    }

    // ë¹„ë°€ê¸€ ì„¤ì • í™•ì¸
    const isPrivate = document.getElementById('isPrivateDiscussion').checked;
    const entryCode = document.getElementById('entryCode').value.trim();

    const formData = {
        title: document.getElementById('discussionTitle').value.trim(),
        type: document.querySelector('input[name="discussionMode"]:checked').value,
        author: document.getElementById('discussionAuthor').value.trim(),
        password: document.getElementById('discussionPassword').value.trim(),
        description: document.getElementById('discussionDescription').value.trim(),
        duration: duration,
        prosName: document.getElementById('prosName')?.value || 'ì°¬ì„±',
        consName: document.getElementById('consName')?.value || 'ë°˜ëŒ€',
        roleList: document.getElementById('roleList')?.value || '',
        isPrivate: isPrivate,
        entryCode: entryCode
    };

    if (!formData.title || !formData.author || !formData.password) {
        showToast('ì œëª©, ì‘ì„±ì, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    // ë¹„ë°€ê¸€ì¸ ê²½ìš° ì…ì¥ì½”ë“œ ê²€ì¦
    if (formData.isPrivate && (!formData.entryCode || formData.entryCode.length < 4)) {
        showToast('ë¹„ë°€ê¸€ì˜ ê²½ìš° 4ìë¦¬ ì´ìƒì˜ ì…ì¥ì½”ë“œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    if (formData.type === 'custom' && !formData.duration) {
        showToast('ì‚¬ìš©ì ì…ë ¥ ê¸°ê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    try {
        showLoading();

        const discussionForm = document.getElementById('newDiscussionForm');
        const isEditMode = discussionForm.dataset.editMode === 'true';
        const editId = discussionForm.dataset.editId;

        if (isEditMode) {
            // ìˆ˜ì • ëª¨ë“œ
            try {
                const response = await fetch(`/api/discussions/${editId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                console.log('APIë¥¼ í†µí•´ í† ë¡  ìˆ˜ì • ì„±ê³µ');

            } catch (apiError) {
                console.error('API ìˆ˜ì • ì‹¤íŒ¨, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë°±:', apiError);

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìˆ˜ì •
                const index = localDiscussions.findIndex(d => d.id == editId);
                if (index > -1) {
                    localDiscussions[index] = {
                        ...localDiscussions[index],
                        ...formData,
                        expires_at: new Date(Date.now() + formData.duration * 60 * 60 * 1000)
                    };
                    localStorage.setItem('localDiscussions', JSON.stringify(localDiscussions));
                }
            }
        } else {
            // ìƒì„± ëª¨ë“œ
            try {
                const response = await fetch('/api/discussions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('APIë¥¼ í†µí•´ í† ë¡  ìƒì„± ì„±ê³µ:', result);

                // ë¹„ë°€ë²ˆí˜¸ ì €ì¥
                localStorage.setItem(`discussion_${result.id}_password`, formData.password);

            } catch (apiError) {
                console.error('API í˜¸ì¶œ ì‹¤íŒ¨, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë°±:', apiError);

            // API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë°±
            const newDiscussion = {
                id: Date.now(),
                title: formData.title,
                type: formData.type,
                author: formData.author,
                description: formData.description,
                participants: 0,
                timeRemaining: `${formData.duration}ì‹œê°„ 0ë¶„`,
                created_at: new Date(),
                expires_at: new Date(Date.now() + formData.duration * 60 * 60 * 1000),
                pros: [],
                cons: []
            };

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                localDiscussions.unshift(newDiscussion);
                localStorage.setItem('localDiscussions', JSON.stringify(localDiscussions));

                // ë¹„ë°€ë²ˆí˜¸ ì €ì¥
                localStorage.setItem(`discussion_${newDiscussion.id}_password`, formData.password);
            }
        }

        closeNewDiscussionModal();
        const formEl = document.getElementById('newDiscussionForm');
        const editModeActive = formEl.dataset.editMode === 'true';
        showToast(editModeActive ? 'í† ë¡ ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ìƒˆ í† ë¡ ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        await loadDiscussions();

    } catch (error) {
        console.error('í† ë¡  ìƒì„± ì˜¤ë¥˜:', error);
        showToast('í† ë¡ ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    } finally {
        hideLoading();
    }
}

// OLD IMPLEMENTATION - Deprecated (localStorage only)
// Replaced by handleOpinionSubmit (line 1227) which uses PostgreSQL
/*
async function handleNewOpinion(e) {
    e.preventDefault();

    if (!currentDiscussion) {
        showToast('í† ë¡ ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    const formData = {
        author: document.getElementById('opinionAuthor').value.trim(),
        content: document.getElementById('opinionContent').value.trim(),
        opinion_type: document.getElementById('opinionType').value
    };

    if (!formData.author || !formData.content || !formData.opinion_type) {
        showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    try {
        showLoading();

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í† ë¡  ì°¾ê¸°
        const discussionIndex = localDiscussions.findIndex(d => d.id === currentDiscussion.id);
        if (discussionIndex === -1) {
            showToast('í† ë¡ ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        // ìƒˆ ì˜ê²¬ ì¶”ê°€
        const newOpinion = {
            id: Date.now(),
            author: formData.author,
            content: formData.content,
            created_at: new Date(),
            likes_count: 0
        };

        // ì°¬ì„±/ë°˜ëŒ€ì— ë”°ë¼ ì˜ê²¬ ì¶”ê°€
        if (formData.opinion_type === 'pros') {
            localDiscussions[discussionIndex].pros = localDiscussions[discussionIndex].pros || [];
            localDiscussions[discussionIndex].pros.unshift(newOpinion);
        } else {
            localDiscussions[discussionIndex].cons = localDiscussions[discussionIndex].cons || [];
            localDiscussions[discussionIndex].cons.unshift(newOpinion);
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        localStorage.setItem('localDiscussions', JSON.stringify(localDiscussions));

        showToast('ì˜ê²¬ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

        // Reset form
        document.getElementById('opinionForm').reset();

        // Reload discussion detail
        await openDiscussionDetail(currentDiscussion.id);

    } catch (error) {
        console.error('ì˜ê²¬ ì¶”ê°€ ì˜¤ë¥˜:', error);
        showToast('ì˜ê²¬ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    } finally {
        hideLoading();
    }
}
*/


async function likeOpinion(opinionId) {
    try {
        const result = await apiRequest(`/api/opinions/${opinionId}/like`, {
            method: 'POST'
        });

        showToast(result.message, 'success');

        // Reload discussion detail to update like counts
        if (currentDiscussion) {
            await openDiscussionDetail(currentDiscussion.id);
        }

    } catch (error) {
        console.error('ì¢‹ì•„ìš” ì˜¤ë¥˜:', error);
        if (error.message.includes('ì´ë¯¸')) {
            showToast('ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤.', 'info');
        } else {
            showToast('ì¢‹ì•„ìš”ë¥¼ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        }
    }
}

// Utility functions
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, (m) => map[m]);
}

function formatTimeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
    if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
    if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
    return `${diffDays}ì¼ ì „`;
}

// Toast notification
function showToast(message, type = 'info') {
    const toastIcon = toast.querySelector('.toast-icon');
    const toastMessage = toast.querySelector('.toast-message');

    // Reset classes
    toast.className = 'toast';

    // Set icon based on type
    switch (type) {
        case 'success':
            toastIcon.className = 'toast-icon fas fa-check-circle';
            toast.classList.add('success');
            break;
        case 'error':
            toastIcon.className = 'toast-icon fas fa-exclamation-circle';
            toast.classList.add('error');
            break;
        case 'info':
        default:
            toastIcon.className = 'toast-icon fas fa-info-circle';
            toast.classList.add('info');
            break;
    }

    toastMessage.textContent = message;
    toast.classList.add('show');

    // Auto hide after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // ESC to close modals
    if (e.key === 'Escape') {
        if (newDiscussionModal.classList.contains('active')) {
            closeNewDiscussionModal();
        }
        if (discussionDetailModal.classList.contains('active')) {
            closeDiscussionDetailModal();
        }
    }

    // Ctrl+K to focus search
    if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
    }

    // Ctrl+N to create new discussion
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        openNewDiscussionModal();
    }
});

// Smooth scrolling for internal links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Online/offline status
window.addEventListener('online', () => {
    showToast('ì¸í„°ë„· ì—°ê²°ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    loadDiscussions();
});

window.addEventListener('offline', () => {
    showToast('ì¸í„°ë„· ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.', 'error');
});

// Performance monitoring
if ('performance' in window) {
    window.addEventListener('load', () => {
        const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
        console.log(`í˜ì´ì§€ ë¡œë“œ ì‹œê°„: ${loadTime}ms`);
    });
}

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
let isAdmin = localStorage.getItem('isAdmin') === 'true';

// ê´€ë¦¬ì ë¡œê·¸ì¸ (ì½˜ì†”ì—ì„œ adminLogin('admin123') í˜¸ì¶œ)
window.adminLogin = function(password) {
    if (password === 'admin123') {
        isAdmin = true;
        localStorage.setItem('isAdmin', 'true');
        loadDiscussions(); // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§
        showToast('ê´€ë¦¬ì ê¶Œí•œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        return true;
    }
    showToast('ì˜ëª»ëœ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.', 'error');
    return false;
};

// ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ
window.adminLogout = function() {
    isAdmin = false;
    localStorage.removeItem('isAdmin');
    loadDiscussions(); // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§
    showToast('ê´€ë¦¬ì ê¶Œí•œì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
};

// ì•¡ì…˜ ë²„íŠ¼ ë Œë”ë§
function renderActionButtons(discussion) {
    const buttons = [];

    // ìˆ˜ì • ë²„íŠ¼ (ì‘ì„±ìë§Œ)
    buttons.push(`
        <button class="edit-btn" onclick="editDiscussion(event, ${discussion.id})" title="í† ë¡  ìˆ˜ì •">
            <i class="fas fa-edit"></i>
        </button>
    `);

    // ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ì)
    if (isAdmin) {
        buttons.push(`
            <button class="delete-btn admin-delete" onclick="adminDeleteDiscussion(event, ${discussion.id})" title="ê´€ë¦¬ì ì‚­ì œ">
                <i class="fas fa-trash"></i>
            </button>
        `);
    } else {
        buttons.push(`
            <button class="delete-btn" onclick="deleteDiscussion(event, ${discussion.id})" title="í† ë¡  ì‚­ì œ">
                <i class="fas fa-times"></i>
            </button>
        `);
    }

    return buttons.join('');
}

// í† ë¡  ìˆ˜ì •
function editDiscussion(event, discussionId) {
    event.stopPropagation();

    const discussion = currentDiscussions.find(d => d.id === discussionId);
    if (!discussion) return;

    // ì‘ì„±ì í™•ì¸
    const password = prompt('ìˆ˜ì •í•˜ë ¤ë©´ í† ë¡  ìƒì„± ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (!password) return;

    // ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸í•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ í™•ì¸
    const savedPassword = localStorage.getItem(`discussion_${discussionId}_password`);
    if (savedPassword && savedPassword !== password) {
        showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
        return;
    }

    // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    openEditModal(discussion);
}

// ê´€ë¦¬ì ì‚­ì œ
function adminDeleteDiscussion(event, discussionId) {
    event.stopPropagation();

    if (!isAdmin) {
        showToast('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
        return;
    }

    const discussion = currentDiscussions.find(d => d.id === discussionId);
    if (!discussion) return;

    if (confirm(`ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ "${discussion.title}" í† ë¡ ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        performDeleteDiscussion(discussionId);
    }
}

// ì¼ë°˜ ì‚¬ìš©ì ì‚­ì œ (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)
function deleteDiscussion(event, discussionId) {
    event.stopPropagation();

    const discussion = currentDiscussions.find(d => d.id === discussionId);
    if (!discussion) return;

    const password = prompt('ì‚­ì œí•˜ë ¤ë©´ í† ë¡  ìƒì„± ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (!password) return;

    if (confirm(`"${discussion.title}" í† ë¡ ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        performDeleteDiscussion(discussionId, password);
    }
}

// ì‹¤ì œ ì‚­ì œ ìˆ˜í–‰
async function performDeleteDiscussion(discussionId, password) {
    try {
        showLoading();
        console.log('ì‚­ì œ ìš”ì²­:', { discussionId, password });

        // API í˜¸ì¶œ
        const result = await apiRequest(`/api/discussions/${discussionId}`, {
            method: 'DELETE',
            body: JSON.stringify({ password: password })
        });

        console.log('ì‚­ì œ ì„±ê³µ:', result);
        showToast('í† ë¡ ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        await loadDiscussions();

    } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        showToast(error.message || 'í† ë¡  ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
        hideLoading();
    }
}

// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function openEditModal(discussion) {
    // ìƒˆ í† ë¡  ëª¨ë‹¬ì„ ìˆ˜ì •ìš©ìœ¼ë¡œ ì¬ì‚¬ìš©
    document.getElementById('discussionTitle').value = discussion.title;
    document.getElementById('discussionAuthor').value = discussion.author;
    document.getElementById('discussionDescription').value = discussion.description || '';

    // í† ë¡  ìœ í˜• ì„¤ì •
    const modeRadio = document.querySelector(`input[name="discussionMode"][value="${discussion.type}"]`);
    if (modeRadio) {
        modeRadio.checked = true;
        handleModeChange(); // ê´€ë ¨ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
    }

    // ëª¨ë‹¬ íƒ€ì´í‹€ ë³€ê²½
    document.querySelector('#newDiscussionModal h2').textContent = 'í† ë¡  ìˆ˜ì •í•˜ê¸°';

    // ìˆ˜ì • ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
    const editForm = document.getElementById('newDiscussionForm');
    editForm.dataset.editMode = 'true';
    editForm.dataset.editId = discussion.id;

    // ì œì¶œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
    document.querySelector('#newDiscussionForm button[type="submit"]').textContent = 'ìˆ˜ì •';

    openNewDiscussionModal();
}

// ëª¨ë“œ ë³€ê²½ ì²˜ë¦¬
function handleModeChange() {
    const selectedMode = document.querySelector('input[name="discussionMode"]:checked').value;
    const prosConsSection = document.getElementById('prosConsSection');
    const roleSection = document.getElementById('roleSection');

    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    prosConsSection.style.display = 'none';
    roleSection.style.display = 'none';

    // ì„ íƒëœ ëª¨ë“œì— ë”°ë¼ ì„¹ì…˜ í‘œì‹œ
    if (selectedMode === 'íŒ€ì „') {
        prosConsSection.style.display = 'block';
    } else if (selectedMode === 'ì—­í• ê·¹') {
        roleSection.style.display = 'block';
    }
}

// ê¸°ê°„ ì„ íƒ ì²˜ë¦¬
function handleDurationChange() {
    const durationSelect = document.getElementById('discussionDuration');
    const customDurationSection = document.getElementById('customDurationSection');

    if (durationSelect.value === 'custom') {
        customDurationSection.style.display = 'block';
    } else {
        customDurationSection.style.display = 'none';
    }
}

// ë¹„ë°€ê¸€ í† ê¸€ í•¸ë“¤ëŸ¬
function handlePrivateToggle() {
    const privateToggle = document.getElementById('isPrivateDiscussion');
    const entryCodeSection = document.getElementById('entryCodeSection');

    if (privateToggle.checked) {
        entryCodeSection.style.display = 'block';
        // ì…ì¥ì½”ë“œ í•„ìˆ˜ ì…ë ¥ ì„¤ì •
        const entryCodeInput = document.getElementById('entryCode');
        entryCodeInput.required = true;
    } else {
        entryCodeSection.style.display = 'none';
        // ì…ì¥ì½”ë“œ í•„ìˆ˜ ì…ë ¥ í•´ì œ
        const entryCodeInput = document.getElementById('entryCode');
        entryCodeInput.required = false;
        entryCodeInput.value = '';
    }
}

// ì…ì¥ì½”ë“œ ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
let pendingDiscussionId = null;

// ì…ì¥ì½”ë“œ ëª¨ë‹¬ í‘œì‹œ
async function showEntryCodeModal(discussionId) {
    pendingDiscussionId = discussionId;
    const modal = document.getElementById('entryCodeModal');
    const input = document.getElementById('entryCodeInput');
    input.value = '';
    modal.style.display = 'flex';
    input.focus();
}

// ì…ì¥ì½”ë“œ ëª¨ë‹¬ ë‹«ê¸°
function closeEntryCodeModal() {
    const modal = document.getElementById('entryCodeModal');
    modal.style.display = 'none';
    pendingDiscussionId = null;
}

// ì…ì¥ì½”ë“œ ê²€ì¦
async function verifyEntryCode() {
    if (!pendingDiscussionId) return;

    const entryCode = document.getElementById('entryCodeInput').value.trim();
    if (!entryCode) {
        showToast('ì…ì¥ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        return;
    }

    try {
        showLoading();
        console.log('ì…ì¥ì½”ë“œ ê²€ì¦ ì‹œì‘:', pendingDiscussionId, entryCode);

        const result = await apiRequest(`/api/discussions/${pendingDiscussionId}/verify-entry`, {
            method: 'POST',
            body: JSON.stringify({ entryCode })
        });

        console.log('ì…ì¥ì½”ë“œ ê²€ì¦ ì„±ê³µ:', result);

        // ê²€ì¦ ì„±ê³µ í›„ í† ë¡ ë°© ì—´ê¸° (ë¹„ë°€ë°© ì²´í¬ ê±´ë„ˆë›°ê¸°)
        const discussionId = pendingDiscussionId;
        console.log('ë¹„ë°€ë°© ì—´ê¸° ì‹œë„:', discussionId);

        closeEntryCodeModal();
        await openDiscussionDetail(discussionId, true);
    } catch (error) {
        console.error('ì…ì¥ì½”ë“œ ê²€ì¦ ì˜¤ë¥˜:', error);
        showToast(error.message || 'ì…ì¥ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
    } finally {
        hideLoading();
    }
}

// ìë™ AI ì„¤ëª… ìƒì„± (í† ë¡  ì œëª© ì…ë ¥ ì‹œ)
async function autoGenerateDescription(title) {
    const descriptionTextarea = document.getElementById('discussionDescription');

    // ì´ë¯¸ ì„¤ëª…ì´ ìˆìœ¼ë©´ ìë™ ìƒì„±í•˜ì§€ ì•ŠìŒ
    if (descriptionTextarea.value.trim()) {
        return;
    }

    try {
        const aiDescription = await generateAIDescriptionWithAPI(title);
        if (aiDescription) {
            descriptionTextarea.value = aiDescription;
        }
    } catch (error) {
        console.error('AI ìë™ ìƒì„± ì‹¤íŒ¨:', error);
        // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì„¤ëª… ì‚¬ìš©
        descriptionTextarea.value = `ì´ í† ë¡ ì—ì„œëŠ” "${title}"ì— ëŒ€í•œ ë‹¤ì–‘í•œ ê´€ì ê³¼ ì˜ê²¬ì„ ë‚˜ëˆ„ëŠ” ê³µê°„ì…ë‹ˆë‹¤.

ì°¸ì—¬ìë“¤ì€ ììœ ë¡­ê²Œ ìì‹ ì˜ ìƒê°ì„ í‘œí˜„í•˜ê³ , ì„œë¡œì˜ ì˜ê²¬ì„ ì¡´ì¤‘í•˜ë©° ê±´ì„¤ì ì¸ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
    }
}

// AI ì„¤ëª… ìƒì„± (ë²„íŠ¼ í´ë¦­ ì‹œ)
async function generateAIDescription() {
    const title = document.getElementById('discussionTitle').value.trim();
    const descriptionTextarea = document.getElementById('discussionDescription');

    if (!title) {
        showToast('í† ë¡  ì œëª©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    // AI ìƒì„± ì• ë‹ˆë©”ì´ì…˜
    descriptionTextarea.value = 'í† ë¡  ìƒí™©ì„ ìƒì„±í•˜ëŠ” ì¤‘...';
    descriptionTextarea.disabled = true;

    try {
        const aiDescription = await generateAIDescriptionWithAPI(title);
        descriptionTextarea.value = aiDescription || `ì´ í† ë¡ ì—ì„œëŠ” "${title}"ì— ëŒ€í•œ ë‹¤ì–‘í•œ ê´€ì ê³¼ ì˜ê²¬ì„ ë‚˜ëˆ„ëŠ” ê³µê°„ì…ë‹ˆë‹¤.

ì°¸ì—¬ìë“¤ì€ ììœ ë¡­ê²Œ ìì‹ ì˜ ìƒê°ì„ í‘œí˜„í•˜ê³ , ì„œë¡œì˜ ì˜ê²¬ì„ ì¡´ì¤‘í•˜ë©° ê±´ì„¤ì ì¸ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        showToast('AIê°€ í† ë¡  ìƒí™©ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤!', 'success');
    } catch (error) {
        console.error('AI ìƒì„± ì‹¤íŒ¨:', error);
        descriptionTextarea.value = `ì´ í† ë¡ ì—ì„œëŠ” "${title}"ì— ëŒ€í•œ ë‹¤ì–‘í•œ ê´€ì ê³¼ ì˜ê²¬ì„ ë‚˜ëˆ„ëŠ” ê³µê°„ì…ë‹ˆë‹¤.

ì°¸ì—¬ìë“¤ì€ ììœ ë¡­ê²Œ ìì‹ ì˜ ìƒê°ì„ í‘œí˜„í•˜ê³ , ì„œë¡œì˜ ì˜ê²¬ì„ ì¡´ì¤‘í•˜ë©° ê±´ì„¤ì ì¸ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        showToast('AI ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„¤ëª…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'warning');
    } finally {
        descriptionTextarea.disabled = false;
    }
}

// Gemini APIë¥¼ ì‚¬ìš©í•œ AI ì„¤ëª… ìƒì„±
async function generateAIDescriptionWithAPI(title) {
    // ì„œë²„ì—ì„œ API í‚¤ ë¡œë“œ
    let API_KEY;
    try {
        const configResponse = await fetch('/api/config');
        const config = await configResponse.json();
        API_KEY = config.GEMINI_API_KEY;

        if (!API_KEY) {
            throw new Error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('API ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        throw new Error('API ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

    const prompt = `í† ë¡  ì£¼ì œ: "${title}"

ì´ ì£¼ì œì— ëŒ€í•œ í† ë¡  ë°°ê²½ì„ ì•„ë˜ í˜•ì‹ëŒ€ë¡œ ì‘ì„±í•˜ì„¸ìš”:

ã€ë°°ê²½ã€‘
êµ¬ì²´ì ì¸ ì‚¬ê±´ì´ë‚˜ ìƒí™©ì„ 150ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ì„œìˆ 

ã€ì°¬ì„± ì…ì¥ã€‘
í•µì‹¬ ì£¼ì¥ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ

ã€ë°˜ëŒ€ ì…ì¥ã€‘
í•µì‹¬ ì£¼ì¥ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ

ì¤‘ìš”: ê° í•­ëª©ì€ ã€ ã€‘ë¡œ ì‹œì‘í•˜ê³  ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„`;

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }]
            })
        });

        if (!response.ok) {
            throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
        }

        const data = await response.json();

        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
            const generatedText = data.candidates[0].content.parts[0].text.trim();

            // AI ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
            let formattedText = generatedText;

            // ë¶ˆí•„ìš”í•œ ë§ˆí¬ë‹¤ìš´ ì œê±°
            formattedText = formattedText.replace(/\*\*/g, '');

            // ã€ ã€‘ ê¸°í˜¸ë¥¼ êµ¬ì¡°í™”ëœ í˜•ì‹ìœ¼ë¡œ ë³€ê²½
            formattedText = formattedText.replace(/ã€ë°°ê²½ã€‘/g, 'ğŸ“‹ ìƒí™©:\n');
            formattedText = formattedText.replace(/ã€ì°¬ì„± ì…ì¥ã€‘/g, '\n\nâœ… ì°¬ì„±:\n');
            formattedText = formattedText.replace(/ã€ë°˜ëŒ€ ì…ì¥ã€‘/g, '\n\nâŒ ë°˜ëŒ€:\n');

            // ê° ì„¹ì…˜ ì‚¬ì´ì— êµ¬ë¶„ì„  ì¶”ê°€
            formattedText = formattedText.replace(/(âœ… ì°¬ì„±:)/g, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n$1');
            formattedText = formattedText.replace(/(âŒ ë°˜ëŒ€:)/g, 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n$1');

            return formattedText.trim();
        } else {
            throw new Error('API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Gemini API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        throw error;
    }
}

// ì˜ê²¬ ë¡œë“œ í•¨ìˆ˜
async function loadOpinions(discussionId) {
    try {
        const response = await fetch(`/api/discussions/${discussionId}/opinions`);
        if (!response.ok) throw new Error('ì˜ê²¬ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');

        const opinions = await response.json();

        // ì°¬ì„±/ë°˜ëŒ€ ì˜ê²¬ ë¶„ë¦¬
        const prosOpinions = opinions.filter(op => op.opinion_type === 'pros');
        const consOpinions = opinions.filter(op => op.opinion_type === 'cons');

        // DOM ì—…ë°ì´íŠ¸
        updateOpinionsDisplay(prosOpinions, consOpinions);
    } catch (error) {
        console.error('ì˜ê²¬ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ì˜ê²¬ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateOpinionsDisplay(prosOpinions, consOpinions) {
    // ì°¬ì„± ì˜ê²¬
    const prosContainer = document.getElementById('prosOpinions');
    const prosCount = document.getElementById('prosCount');
    if (prosContainer && prosCount) {
        prosCount.textContent = `${prosOpinions.length}ê°œ`;
        if (prosOpinions.length === 0) {
            prosContainer.innerHTML = '<p class="no-opinions">ì•„ì§ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            prosContainer.innerHTML = prosOpinions.map(op => `
                <div class="opinion-item">
                    <div class="opinion-header">
                        <strong>${op.author}</strong>
                        <span class="opinion-time">${new Date(op.created_at).toLocaleString()}</span>
                    </div>
                    <p class="opinion-content">${op.content}</p>
                </div>
            `).join('');
        }
    }

    // ë°˜ëŒ€ ì˜ê²¬
    const consContainer = document.getElementById('consOpinions');
    const consCount = document.getElementById('consCount');
    if (consContainer && consCount) {
        consCount.textContent = `${consOpinions.length}ê°œ`;
        if (consOpinions.length === 0) {
            consContainer.innerHTML = '<p class="no-opinions">ì•„ì§ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            consContainer.innerHTML = consOpinions.map(op => `
                <div class="opinion-item">
                    <div class="opinion-header">
                        <strong>${op.author}</strong>
                        <span class="opinion-time">${new Date(op.created_at).toLocaleString()}</span>
                    </div>
                    <p class="opinion-content">${op.content}</p>
                </div>
            `).join('');
        }
    }
}

// ì˜ê²¬ ì œì¶œ
async function handleOpinionSubmit(e) {
    e.preventDefault();

    if (!currentDiscussion) {
        showToast('í† ë¡ ë°© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }

    const author = document.getElementById('opinionAuthor').value.trim();
    const content = document.getElementById('opinionContent').value.trim();
    const opinion_type = document.getElementById('opinionType').value;

    console.log('ì˜ê²¬ ì œì¶œ ì‹œë„:', { author, content, opinion_type });

    if (!author || !content || !opinion_type) {
        console.error('ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨:', {
            author: !!author,
            content: !!content,
            opinion_type: !!opinion_type
        });
        showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/discussions/${currentDiscussion.id}/opinions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ author, content, opinion_type })
        });

        if (response.ok) {
            showToast('ì˜ê²¬ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            document.getElementById('opinionForm').reset();
            await loadOpinions(currentDiscussion.id);
        } else {
            const error = await response.json();
            throw new Error(error.error || 'ì˜ê²¬ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ì˜ê²¬ ì¶”ê°€ ì˜¤ë¥˜:', error);
        showToast(error.message, 'error');
    }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', function() {
    const opinionForm = document.getElementById('opinionForm');
    if (opinionForm) {
        opinionForm.addEventListener('submit', handleOpinionSubmit);
    }
});

// Service Worker registration (for future PWA features)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // navigator.serviceWorker.register('/sw.js')
        //     .then(registration => console.log('SW registered'))
        //     .catch(error => console.log('SW registration failed'));
    });
}